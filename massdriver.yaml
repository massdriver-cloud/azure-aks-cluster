schema: draft-07
name: azure-aks-cluster
description: "Azure Kubernetes Service (AKS) is a fully managed container orchestration service. AKS offers serverless Kubernetes, an integrated continuous integration and continuous delivery (CI/CD) experience, and enterprise-grade security and governance."
source_url: github.com/massdriver-cloud/azure-aks-cluster
access: "private"
type: bundle

steps:
  - path: src
    provisioner: terraform
  - path: core-services
    provisioner: terraform
  - path: custom-resources
    provisioner: terraform

MonitorAlarmMetric: &monitor_alarm_metric
  required:
    - severity
    - frequency
    - window_size
    - aggregation
    - operator
    - threshold
  properties:
    severity:
      title: Severity
      description: The severity of the alarm.
      type: integer
      default: 1
      oneOf:
        - title: Critical
          const: 0
        - title: Error
          const: 1
        - title: Warning
          const: 2
        - title: Information
          const: 3
        - title: Verbose
          const: 4
    frequency:
      title: Frequency
      description: The evaluation frequency of the alarms.
      type: string
      default: PT1M
      oneOf:
        - title: Every 1 minute
          const: PT1M
        - title: Every 5 minutes
          const: PT5M
        - title: Every 15 minutes
          const: PT15M
        - title: Every 30 minutes
          const: PT30M
        - title: Every 1 hour
          const: PT1H
    window_size:
      title: Alarm window
      description: The time range over which the alarm is evaluated.
      type: string
      default: PT5M
      oneOf:
        - title: Every 1 minute
          const: PT1M
        - title: Every 5 minutes
          const: PT5M
        - title: Every 15 minutes
          const: PT15M
        - title: Every 30 minutes
          const: PT30M
        - title: Every 1 hour
          const: PT1H
        - title: Every 6 hours
          const: PT6H
        - title: Every 12 hours
          const: PT12H
        - title: Every 24 hours
          const: P1D
    aggregation:
      title: Aggregation
      description: The aggregation type of the alarm.
      type: string
      default: Average
      enum:
        - Average
        - Count
        - Minimum
        - Maximum
        - Total
    operator:
      title: Operator
      description: The operator used to compare the metric value to the threshold.
      type: string
      default: GreaterThanOrEqual
      oneOf:
        - title: Greater than or equal to
          const: GreaterThanOrEqual
        - title: Greater than
          const: GreaterThan
        - title: Less than or equal to
          const: LessThanOrEqual
        - title: Less than
          const: LessThan
        - title: Equals
          const: Equals
        - title: Not equal to
          const: NotEquals
    threshold:
      title: Threshold
      description: The percentage threshold for the metric to trigger an alarm.
      type: integer
      default: 90
      minimum: 0
      maximum: 100

params:
  examples:
    - __name: Development
      node_groups:
        default_node_group:
          name: default
          min_size: 1
          max_size: 10
          node_size: Standard_D2s_v3
    - __name: Production
      node_groups:
        default_node_group:
          name: default
          min_size: 1
          max_size: 10
          node_size: Standard_D8s_v3
        additional_node_groups:
          - name: shared
            node_size: Standard_D8s_v3
            min_size: 1
            max_size: 10
  required:
    - cluster
    - node_groups
  properties:
    cluster:
      title: Cluster
      description: Configure the Kubernetes cluster
      type: object
      required:
        - kubernetes_version
      properties:
        kubernetes_version:
          type: string
          title: Kubernetes version
          description: The version of Kubernetes that should be used for this cluster. You will be able to upgrade this version after creating the cluster, but you cannot downgrade the version.
          default: "1.24"
          enum:
            - "1.24"
            - "1.23"
        enable_log_analytics:
          type: boolean
          title: Enable Log Analytics
          description: Enable Log Analytics for this cluster.
          default: false
    node_groups:
      type: object
      title: Node groups
      description: The node groups that should be used for this cluster.
      required:
        - default_node_group
      properties:
        default_node_group:
          type: object
          title: Default node group
          description: Configuration of the node group.
          required:
            - name
            - node_size
            - min_size
            - max_size
          properties:
            name:
              type: string
              title: Name
              description: The name of the node group.
              pattern: "[a-z]{1,}[a-z0-9]{0,11}"
              message:
                pattern: This field only accepts lowercase letters and numbers, with a max length of 12 characters. Changing this forces a deletion and re-creation of the node group.
            min_size:
              type: number
              title: Minimum size
              description: Minimum number of instances in the node group.
              default: 1
              minimum: 1
              maximum: 1000
            max_size:
              type: number
              title: Maximum size
              description: Maximum number of instances in the node group.
              default: 10
              minimum: 1
              maximum: 1000
            node_size:
              type: string
              title: Compute size
              description: Compute size to use in the node group (D = General Purpose, E = Memory Optimized, F = Compute Optimized). Changing this forces a deletion and re-creation of the node group.
              oneOf:
                - title: D2s (2 vCores, 8 GiB memory)
                  const: Standard_D2s_v3
                - title: D4s (4 vCores, 16 GiB memory)
                  const: Standard_D4s_v3
                - title: D8s (8 vCores, 32 GiB memory)
                  const: Standard_D8s_v3
                - title: D16s (16 vCores, 64 GiB memory)
                  const: Standard_D16s_v3
                - title: D32s (32 vCores, 64 GiB memory)
                  const: Standard_D32s_v3
                - title: D64s (64 vCores, 256 GiB memory)
                  const: Standard_D64s_v3
                - title: E2s (2 vCores, 16 GiB memory)
                  const: Standard_E2s_v3
                - title: E4s (4 vCores, 32 GiB memory)
                  const: Standard_E4s_v3
                - title: E8s (8 vCores, 64 GiB memory)
                  const: Standard_E8s_v3
                - title: E16s (8 vCores, 128 GiB memory)
                  const: Standard_E16s_v3
                - title: E32s (32 vCores, 256 GiB memory)
                  const: Standard_E32s_v3
                - title: E64s (64 vCores, 432 GiB memory)
                  const: Standard_E64s_v3
                - title: F2s (2 vCores, 4 GiB memory)
                  const: Standard_F2s_v2
                - title: F4s (4 vCores, 8 GiB memory)
                  const: Standard_F4s_v2
                - title: F8s (8 vCores, 16 GiB memory)
                  const: Standard_F8s_v2
                - title: F16s (16 vCores, 32 GiB memory)
                  const: Standard_F16s_v2
                - title: F32s (32 vCores, 64 GiB memory)
                  const: Standard_F32s_v2
                - title: F64s (64 vCores, 128 GiB memory)
                  const: Standard_F64s_v2
        additional_node_groups:
          type: array
          title: Additional node groups
          default: []
          items:
            type: object
            title: Node group
            required:
              - name
              - node_size
              - min_size
              - max_size
            properties:
              name:
                type: string
                title: Name
                pattern: "[a-z]{1,}[a-z0-9]{0,11}"
                message:
                  pattern: This field only accepts lowercase letters and numbers, with a max length of 12 characters. Changing this forces a deletion and re-creation of the node group.
              min_size:
                type: number
                title: Minimum size
                description: Minimum number of instances in the node group.
                default: 1
                minimum: 1
                maximum: 1000
              max_size:
                type: number
                title: Maximum size
                description: Maximum number of instances in the node group.
                default: 10
                minimum: 1
                maximum: 1000
              node_size:
                type: string
                title: Compute size
                description: Compute size to use in the node group (D = General Purpose, E = Memory Optimized, F = Compute Optimized). Changing this forces a deletion and re-creation of the node group.
                oneOf:
                  - title: D2s (2 vCores, 8 GiB memory)
                    const: Standard_D2s_v3
                  - title: D4s (4 vCores, 16 GiB memory)
                    const: Standard_D4s_v3
                  - title: D8s (8 vCores, 32 GiB memory)
                    const: Standard_D8s_v3
                  - title: D16s (16 vCores, 64 GiB memory)
                    const: Standard_D16s_v3
                  - title: D32s (32 vCores, 64 GiB memory)
                    const: Standard_D32s_v3
                  - title: D64s (64 vCores, 256 GiB memory)
                    const: Standard_D64s_v3
                  - title: E2s (2 vCores, 16 GiB memory)
                    const: Standard_E2s_v3
                  - title: E4s (4 vCores, 32 GiB memory)
                    const: Standard_E4s_v3
                  - title: E8s (8 vCores, 64 GiB memory)
                    const: Standard_E8s_v3
                  - title: E16s (8 vCores, 128 GiB memory)
                    const: Standard_E16s_v3
                  - title: E32s (32 vCores, 256 GiB memory)
                    const: Standard_E32s_v3
                  - title: E64s (64 vCores, 432 GiB memory)
                    const: Standard_E64s_v3
                  - title: F2s (2 vCores, 4 GiB memory)
                    const: Standard_F2s_v2
                  - title: F4s (4 vCores, 8 GiB memory)
                    const: Standard_F4s_v2
                  - title: F8s (8 vCores, 16 GiB memory)
                    const: Standard_F8s_v2
                  - title: F16s (16 vCores, 32 GiB memory)
                    const: Standard_F16s_v2
                  - title: F32s (32 vCores, 64 GiB memory)
                    const: Standard_F32s_v2
                  - title: F64s (64 vCores, 128 GiB memory)
                    const: Standard_F64s_v2
    core_services:
      type: object
      title: Core Services
      description: Configure core services in Kubernetes for Massdriver to manage.
      required: []
      properties:
        enable_ingress:
          type: boolean
          title: Enable Ingress Controller
          description: Enabling this will create an NGINX Ingress Controller in the cluster, allowing internet traffic to flow into web accessible services within the cluster.
          default: false
        azure_dns_zones:
          type: array
          title: Azure DNS Zone
          description: Add an Azure DNS Zone associated with this cluster to allow Kubernetes to automatically manage DNS records and SSL certificates.
          default: []
          maxItems: 1
          items:
            type: string
    monitoring:
      type: object
      title: Monitoring
      properties:
        mode:
          title: Alarm Mode
          description: Enable and customize Function App metric alarms.
          type: string
          default: AUTOMATED
          oneOf:
            - const: AUTOMATED
              title: Automated
            - const: CUSTOM
              title: Custom
            - const: DISABLED
              title: Disabled
      dependencies:
        mode:
          oneOf:
            - properties:
                mode:
                  const: AUTOMATED
            - properties:
                mode:
                  const: DISABLED
            - properties:
                mode:
                  const: CUSTOM
                alarms:
                  type: object
                  title: Alarms
                  properties:
                    cpu_metric_alert:
                      title: CPU
                      type: object
                      <<: *monitor_alarm_metric
                    memory_metric_alert:
                      title: Memory
                      type: object
                      <<: *monitor_alarm_metric
                    storage_metric_alert:
                      title: Storage
                      type: object
                      <<: *monitor_alarm_metric

connections:
  required:
    - azure_service_principal
    - vnet
  properties:
    azure_service_principal:
      $ref: massdriver/azure-service-principal
    vnet:
      $ref: massdriver/azure-virtual-network

artifacts:
  required:
    - kubernetes_cluster
  properties:
    kubernetes_cluster:
      $ref: massdriver/kubernetes-cluster

ui:
  ui:order:
    - cluster
    - node_groups
    - core_services
    - monitoring
    - "*"
  cluster:
    ui:order:
      - kubernetes_version
      - enable_log_analytics
  node_groups:
    ui:order:
      - default_node_group
      - additional_node_groups
      - "*"
    default_node_group:
      ui:order:
        - name
        - node_size
        - min_size
        - max_size
        - "*"
    additional_node_groups:
      items:
        ui:order:
          - name
          - node_size
          - min_size
          - max_size
          - "*"
  core_services:
    ui:order:
      - enable_ingress
      - azure_dns_zones
      - "*"
    azure_dns_zones:
      items:
        ui:field: dnsZonesDropdown
        cloud: azure
  monitoring:
    ui:order:
      - mode
      - alarms
      - '*'
    alarms:
      ui:order:
        - cpu_metric_alert
        - memory_metric_alert
        - storage_metric_alert
        - '*'
      cpu_metric_alert: &monitor_alarm_metric_ui
        ui:order:
          - severity
          - operator
          - aggregation
          - frequency
          - window_size
          - threshold
          - '*'
      memory_metric_alert:
        <<: *monitor_alarm_metric_ui
      storage_metric_alert:
        <<: *monitor_alarm_metric_ui
