schema: draft-07
name: azure-aks-cluster
description: "Azure Kubernetes Service (AKS) is a fully managed container orchestration service. AKS offers serverless Kubernetes, an integrated continuous integration and continuous delivery (CI/CD) experience, and enterprise-grade security and governance."
ref: github.com/massdriver-cloud/massdriver-bundles/bundles/azure-aks-cluster
access: "public"
type: bundle

steps:
  - path: src
    provisioner: terraform
  - path: core-services
    provisioner: terraform
  - path: custom-resources
    provisioner: terraform

params:
  examples:
    - __name: Development
      node_groups:
        default_node_group:
          name: default
          min_size: 1
          max_size: 10
          node_size: Standard_D2s_v3
    - __name: Production
      node_groups:
        default_node_group:
          name: default
          min_size: 1
          max_size: 10
          node_size: Standard_D8s_v3
        additional_node_groups:
          - name: shared
            node_size: Standard_D8s_v3
            min_size: 1
            max_size: 10
  required:
    - kubernetes_version
    - network_profile
    - node_groups
  properties:
    kubernetes_version:
      type: string
      title: Kubernetes version
      description: The version of Kubernetes that should be used for this cluster. You will be able to upgrade this version after creating the cluster, but you cannot downgrade the version.
      default: "1.23.5"
      enum:
        - "1.23.5"
        - "1.23.3"
        - "1.22.6"
        - "1.22.4"
        - "1.21.9"
        - "1.21.7"
    network_profile:
      type: object
      title: Cluster network profile
      description: The network profile that should be used for this cluster.
      required:
        - dns_service_ip
        - docker_bridge_cidr
        - service_cidr
      properties:
        service_cidr:
          type: string
          title: Service CIDR
          description: The Network Range (/16 in size) used by the Kubernetes service. This cannot be changed after creation.
          $md.immutable: true
          default: "172.16.0.0/16"
          pattern: "^(?:10(?:\\.(?:[0-9]|[0-9]{2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5]))|172(?:\\.(?:1[6-9]|2[0-9]|3[0-1]))|192(?:\\.(?:168)))(?:\\.(?:[0-9]|[0-9]{2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5])){2}/16$"
          message:
            pattern: Invalid CIDR. Must be a /16 private networking space (10.X.X.X/16, 172.16-31.X.X/16, 192.168.X.X/16) that does not conflict with your VNet address space.
        dns_service_ip:
          type: string
          title: DNS service IP
          description: IP address within the Kubernetes service address range above that will be used by cluster service discovery (kube-dns). This cannot be changed after creation.
          $md.immutable: true
          default: "172.16.0.10"
          $ref: https://raw.githubusercontent.com/massdriver-cloud/artifact-definitions/main/definitions/types/ip-address.json
          message:
            pattern: Invalid IP address. Must be an IP address within the Service CIDR address range using private networking space (10.X.X.X, 172.16-31.X.X, 192.168.X.X).
        docker_bridge_cidr:
          type: string
          title: Docker bridge CIDR
          description: IP address range used as the Docker bridge IP address on nodes. This cannot be changed after creation.
          $md.immutable: true
          default: "170.10.0.1/16"
          pattern: "^170\\.[0-9]+\\.0\\.1/16$"
          message:
            pattern: Invalid CIDR. Must be a CIDR that uses the format of 170.x.0.1/16.
    node_groups:
      type: object
      title: Node groups
      description: The node groups that should be used for this cluster.
      required:
        - default_node_group
      properties:
        default_node_group:
          type: object
          title: Default node group
          description: Configuration of the node group.
          required:
            - name
            - node_size
            - min_size
            - max_size
          properties:
            name:
              type: string
              title: Name
              description: The name of the node group.
              pattern: "[a-z]{1,}[a-z0-9]{0,11}"
              message:
                pattern: This field only accepts lowercase letters and numbers, with a max length of 12 characters. Changing this forces a deletion and re-creation of the node group.
            min_size:
              type: number
              title: Minimum size
              description: Minimum number of instances in the node group.
              default: 1
              minimum: 1
              maximum: 1000
            max_size:
              type: number
              title: Maximum size
              description: Maximum number of instances in the node group.
              default: 10
              minimum: 1
              maximum: 1000
            node_size:
              type: string
              title: Compute size
              description: Compute size to use in the node group (D = General Purpose, E = Memory Optimized, F = Compute Optimized). Changing this forces a deletion and re-creation of the node group.
              oneOf:
                - title: D2s (2 vCores, 8 GiB memory)
                  const: Standard_D2s_v3
                - title: D4s (4 vCores, 16 GiB memory)
                  const: Standard_D4s_v3
                - title: D8s (8 vCores, 32 GiB memory)
                  const: Standard_D8s_v3
                - title: D16s (16 vCores, 64 GiB memory)
                  const: Standard_D16s_v3
                - title: D32s (32 vCores, 64 GiB memory)
                  const: Standard_D32s_v3
                - title: D64s (64 vCores, 256 GiB memory)
                  const: Standard_D64s_v3
                - title: E2s (2 vCores, 16 GiB memory)
                  const: Standard_E2s_v3
                - title: E4s (4 vCores, 32 GiB memory)
                  const: Standard_E4s_v3
                - title: E8s (8 vCores, 64 GiB memory)
                  const: Standard_E8s_v3
                - title: E16s (8 vCores, 128 GiB memory)
                  const: Standard_E16s_v3
                - title: E32s (32 vCores, 256 GiB memory)
                  const: Standard_E32s_v3
                - title: E64s (64 vCores, 432 GiB memory)
                  const: Standard_E64s_v3
                - title: F2s (2 vCores, 4 GiB memory)
                  const: Standard_F2s_v2
                - title: F4s (4 vCores, 8 GiB memory)
                  const: Standard_F4s_v2
                - title: F8s (8 vCores, 16 GiB memory)
                  const: Standard_F8s_v2
                - title: F16s (16 vCores, 32 GiB memory)
                  const: Standard_F16s_v2
                - title: F32s (32 vCores, 64 GiB memory)
                  const: Standard_F32s_v2
                - title: F64s (64 vCores, 128 GiB memory)
                  const: Standard_F64s_v2
        additional_node_groups:
          type: array
          title: Additional node groups
          description: Additional node groups to provision.
          default: []
          items:
            type: object
            title: Node group
            description: Configuration of a node group.
            required:
              - name
              - node_size
              - min_size
              - max_size
            properties:
              name:
                type: string
                title: Name
                description: The name of this node group.
                pattern: "[a-z]{1,}[a-z0-9]{0,11}"
                message:
                  pattern: This field only accepts lowercase letters and numbers, with a max length of 12 characters. Changing this forces a deletion and re-creation of the node group.
              min_size:
                type: number
                title: Minimum size
                description: Minimum number of instances in the node group.
                default: 1
                minimum: 1
                maximum: 1000
              max_size:
                type: number
                title: Maximum size
                description: Maximum number of instances in the node group.
                default: 10
                minimum: 1
                maximum: 1000
              node_size:
                type: string
                title: Compute size
                description: Compute size to use in the node group (D = General Purpose, E = Memory Optimized, F = Compute Optimized). Changing this forces a deletion and re-creation of the node group.
                oneOf:
                  - title: D2s (2 vCores, 8 GiB memory)
                    const: Standard_D2s_v3
                  - title: D4s (4 vCores, 16 GiB memory)
                    const: Standard_D4s_v3
                  - title: D8s (8 vCores, 32 GiB memory)
                    const: Standard_D8s_v3
                  - title: D16s (16 vCores, 64 GiB memory)
                    const: Standard_D16s_v3
                  - title: D32s (32 vCores, 64 GiB memory)
                    const: Standard_D32s_v3
                  - title: D64s (64 vCores, 256 GiB memory)
                    const: Standard_D64s_v3
                  - title: E2s (2 vCores, 16 GiB memory)
                    const: Standard_E2s_v3
                  - title: E4s (4 vCores, 32 GiB memory)
                    const: Standard_E4s_v3
                  - title: E8s (8 vCores, 64 GiB memory)
                    const: Standard_E8s_v3
                  - title: E16s (8 vCores, 128 GiB memory)
                    const: Standard_E16s_v3
                  - title: E32s (32 vCores, 256 GiB memory)
                    const: Standard_E32s_v3
                  - title: E64s (64 vCores, 432 GiB memory)
                    const: Standard_E64s_v3
                  - title: F2s (2 vCores, 4 GiB memory)
                    const: Standard_F2s_v2
                  - title: F4s (4 vCores, 8 GiB memory)
                    const: Standard_F4s_v2
                  - title: F8s (8 vCores, 16 GiB memory)
                    const: Standard_F8s_v2
                  - title: F16s (16 vCores, 32 GiB memory)
                    const: Standard_F16s_v2
                  - title: F32s (32 vCores, 64 GiB memory)
                    const: Standard_F32s_v2
                  - title: F64s (64 vCores, 128 GiB memory)
                    const: Standard_F64s_v2
    core_services:
      type: object
      title: Core Services
      description: Configure core services in Kubernetes for Massdriver to manage.
      required: []
      properties:
        enable_ingress:
          type: boolean
          title: Enable Ingress Controller
          description: Enabling this will create an NGINX Ingress Controller in the cluster, allowing internet traffic to flow into web accessible services within the cluster.
          default: false
        azure_dns_zones:
          type: object
          title: Azure DNS Zones
          description: List any Azure DNS Zones associated with this cluster to allow the Kubernetes to automatically manage DNS records and SSL certificates.
          # not supported by our current MUI implementation, but useful once it is: https://json-schema.org/understanding-json-schema/reference/conditionals.html#id5
          dependentRequired:
            dns_zones:
              - resource_group
            resource_group:
              - dns_zones
          properties:
            dns_zones:
              type: array
              title: Azure DNS zone
              description: The name of the Azure DNS zone for the AKS Cluster.
              items:
                type: string
                pattern: "^(?:[a-zA-Z0-9]+\\.)+(?:[a-zA-Z]+)$"
                message:
                  pattern: Must be a valid domain name.
            resource_group:
              type: string
              title: Resource Group name
              description: The name of the Resource Group the Azure DNS zones are in (all zones must share the same Resource Group).
              pattern: "[a-zA-Z0-9-_.()]{1,}[a-zA-Z0-9-_()]{0,89}$"
              message:
                pattern: Must be a valid Resource Group name.

connections:
  required:
    - azure_service_principal
    - vnet
  properties:
    azure_service_principal:
      $ref: massdriver/azure-service-principal
    vnet:
      $ref: massdriver/azure-virtual-network

artifacts:
  required:
    - kubernetes_cluster
  properties:
    kubernetes_cluster:
      $ref: massdriver/kubernetes-cluster

ui:
  ui:order:
    - kubernetes_version
    - network_profile
    - node_groups
    - core_services
    - "*"
  network_profile:
    ui:order:
      - service_cidr
      - dns_service_ip
      - docker_bridge_cidr
  node_groups:
    ui:order:
      - default_node_group
      - additional_node_groups
    default_node_group:
      ui:order:
        - name
        - node_size
        - min_size
        - max_size
        - "*"
    additional_node_groups:
      items:
        ui:order:
          - name
          - node_size
          - min_size
          - max_size
          - "*"
  core_services:
    ui:order:
      - enable_ingress
      - azure_dns_zones
      - "*"
